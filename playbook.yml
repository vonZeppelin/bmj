# Tested on Armbian 5.83 with 4.14 kernel
# ansible-playbook -u root -k -i 192.168.0.111, playbook.yml
---
- hosts: all
  tasks:
  - name: Configure hardware
    block:
      - copy:
          content: 'blacklist xradio_wlan'
          dest: /etc/modprobe.d/blacklist-xradio.conf
      - replace:
          path: /boot/armbianEnv.txt
          regexp: ^(overlays=(?:(?!cir).)*)$
          replace: \1 cir
  - name: Install required packages
    apt:
      name:
        - bluez-tools
        - eject
        - gstreamer1.0-alsa
        - gstreamer1.0-plugins-bad
        - ir-keytable
        - mopidy
        - mopidy-dleyna
        - mpc
        - pulseaudio
        - pulseaudio-module-bluetooth
        - python-dev
        - python-pip
        - python-setuptools
      state: latest
      update_cache: yes
      cache_valid_time: 3600
  - name: Install additional Python modules
    pip:
      name:
        - https://github.com/vonZeppelin/inputexec/archive/master.zip
        - mopidy-cd
        - mopidy-iris
        - mopidy-ydisk
      state: latest
  - name: Configure Pulseaudio service
    block:
      - user:
          name: pulse
          groups: bluetooth
          append: yes
      - lineinfile:
          path: '/etc/pulse/{{ item.file }}'
          line: '{{ item.line }}'
        loop:
          - { file: daemon.conf, line: 'default-sample-format = s24le' }
          - { file: system.pa, line: 'load-module module-bluetooth-discover' }
          - { file: system.pa, line: 'load-module module-bluetooth-policy' }
          - { file: system.pa, line: 'load-module module-switch-on-connect' }
      - copy:
          src: conf/pulseaudio.service
          dest: /etc/systemd/system/
          owner: root
          group: root
          mode: 0644
      - systemd:
          name: pulseaudio
          enabled: yes
          state: started
          daemon_reload: yes
  - name: Configure Mopidy
    block:
      - user:
          name: mopidy
          groups:
            - cdrom
            - pulse-access
          append: yes
      - ini_file:
          path: /etc/mopidy/mopidy.conf
          section: '{{ item.section }}'
          option: '{{ item.option }}'
          value: '{{ item.value }}'
        loop:
          - { section: audio, option: mixer_volume, value: 30 }
          - { section: file, option: enabled, value: false }
          - { section: http, option: hostname, value: 0.0.0.0 }
          - { section: local, option: enabled, value: false }
          - { section: mpd, option: hostname, value: 0.0.0.0 }
          - { section: stream, option: timeout, value: 15000 }
      - copy:
          src: '{{ item }}'
          dest: /var/lib/mopidy/playlists/
          owner: mopidy
          group: audio
          mode: 0644
        with_fileglob:
          - conf/playlists/*.m3u
      - service:
          name: mopidy
          enabled: yes
          state: started
  - name: Configure Remote Control
    block:
      - user:
          name: inputexec
          groups:
            - cdrom
            - input
          create_home: no
      - replace:
          path: '{{ item.path }}'
          regexp: '{{ item.regexp }}'
          replace: '{{ item.replace }}'
        loop:
          - {
            path: /lib/udev/rules.d/60-ir-keytable.rules,
            replace: 'ACTION=="add", SUBSYSTEM=="input", SUBSYSTEMS=="rc", KERNEL=="event*", ENV{.rc_sysdev}="$id", RUN+="/usr/bin/ir-keytable -a /etc/rc_maps.cfg -s $env{.rc_sysdev}"',
            regexp: ^.+name"$
          }
          - {
            path: /etc/rc_maps.cfg,
            replace: '* rc-empty tmih',
            regexp: ^.+total_media_in_hand$
          }
      - copy:
          src: '{{ item.src }}'
          dest: '{{ item.dest }}'
          owner: '{{ item.owner }}'
          group: '{{ item.group }}'
          mode: 0644
        loop:
          - { src: conf/inputexec.service, dest: /etc/systemd/system/, owner: root, group: root }
          - { src: conf/inputexec.cfg, dest: /etc/inputexec.cfg, owner: inputexec, group: input }
          - { src: conf/tmih, dest: /etc/rc_keymaps/, owner: root, group: root }
      - copy:
          content: >
            inputexec ALL= NOPASSWD: /bin/bash
          dest: /etc/sudoers.d/inputexec
          mode: 0644
      - systemd:
          name: inputexec
          enabled: yes
          state: started
          daemon_reload: yes
  - name: Configure VirtualHere
    block:
      - get_url:
          url: https://virtualhere.com/sites/default/files/usbserver/vhusbdarm
          dest: /usr/bin/vhusbd
          owner: root
          group: root
          mode: 0744
      - copy:
          src: '{{ item.src }}'
          dest: '{{ item.dest }}'
          owner: root
          group: root
        loop:
          - { src: conf/virtualhere.service, dest: /etc/systemd/system/ }
          - { src: conf/virtualhere.cfg, dest: /etc/virtualhere.cfg }
      - systemd:
          name: virtualhere
          enabled: yes
          state: started
          daemon_reload: yes
